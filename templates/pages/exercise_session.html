{% extends "base_authenticated.html" %}
{% load static %}

{% block title %}Exercise session | Knees{% endblock %}

{% block content %}
<style>
  .slider-field { position: relative; }
  .slider__bubble { position: absolute; left: 50%; bottom: calc(100% + 10px); transform: translate(-50%, -4px) scale(0.98); background: #0f172a; color: white; padding: 0.4rem 0.65rem 0.5rem; border-radius: 0.75rem; min-width: 120px; text-align: center; box-shadow: 0 10px 20px rgba(15, 23, 42, 0.14); display: inline-flex; flex-direction: column; gap: 0.1rem; pointer-events: none; opacity: 0; visibility: hidden; transition: opacity 120ms ease, transform 120ms ease, visibility 120ms ease; }
  .slider-field.is-active .slider__bubble { opacity: 1; visibility: visible; transform: translate(-50%, -6px); }
  .slider__value { font-weight: 800; }
  .slider__detail { font-size: 0.85rem; color: #cbd5e1; }
  .slider__arrow { position: absolute; bottom: -7px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 7px solid transparent; border-right: 7px solid transparent; border-top: 7px solid #0f172a; }
  .fas-slider { width: 100%; appearance: none; height: 8px; border-radius: 999px; background: #e2e8f0; outline: none; }
  .fas-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; border-radius: 50%; background: #4f46e5; cursor: pointer; border: 3px solid white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
  .fas-slider::-moz-range-thumb { width: 22px; height: 22px; border-radius: 50%; background: #4f46e5; cursor: pointer; border: 3px solid white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
  .slider__labels { display: flex; justify-content: space-between; font-weight: 700; color: #475569; margin-top: 0.5rem; }
</style>

<section class="relative overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-soft">
  <div class="absolute inset-0 bg-gradient-to-br from-slate-50 via-white to-white"></div>
  <div class="relative p-6 sm:p-10">
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-12 lg:items-center">
      <div class="lg:col-span-7">
        <h1 class="mt-1 text-2xl font-semibold tracking-tight text-slate-900 sm:text-3xl">{{ title }}</h1>
        <div class="mt-3 flex flex-wrap items-center gap-x-3 gap-y-1 text-sm">
          {% if current_step %}
          <span class="text-slate-600">
            <span class="font-semibold text-slate-900">Set {{ current_step.set_number }}</span>
            <span class="text-slate-500">of {{ current_step.daily_exercise.sets|default:1 }}</span>
          </span>
          <span class="text-slate-300">•</span>
          {% elif post_exercise_stage == 0 %}
          <span class="text-slate-600">
            <span class="font-semibold text-slate-900">Recovery</span>
            <span class="text-slate-500">check-in</span>
          </span>
          <span class="text-slate-300">•</span>
          {% elif post_exercise_stage == 1 %}
          <span class="text-slate-600">
            <span class="font-semibold text-slate-900">Fatigue</span>
            <span class="text-slate-500">assessment</span>
          </span>
          <span class="text-slate-300">•</span>
          {% endif %}
          <span class="text-slate-600">
            <span class="font-semibold text-slate-900">{{ progress_percent|floatformat:0 }}%</span>
            <span class="text-slate-500">complete</span>
          </span>
        </div>
      </div>

      <div class="lg:col-span-5">
        <div class="rounded-2xl bg-white/70 p-4 backdrop-blur sm:p-5">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold text-slate-900">Progress</div>
            {% with completed=current_step_number|add:"-1" %}
            <div class="text-sm text-slate-500">
              <span class="font-semibold text-slate-900">{{ completed|default_if_none:0 }}</span> / {{ total_steps }}
            </div>
            {% endwith %}
          </div>
          <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-slate-100">
            <div class="h-full rounded-full bg-indigo-600 transition-all" style="width: {{ progress_percent }}%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="mt-6">
  {% if steps %}
    {% if current_step %}
      <section class="grid grid-cols-1 gap-6 lg:grid-cols-12">
        <div class="lg:col-span-7">
          <div class="overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-soft">
            <div class="border-b border-slate-200 px-6 py-5">
              <h2 class="text-base font-semibold tracking-tight text-slate-900">Demonstration</h2>
              <p class="mt-1 text-sm text-slate-600">Follow the movement slowly and stay within a pain-free range.</p>
            </div>
            <figure class="bg-slate-50">
              <img
                src="{% static 'exercises' %}/{{ current_step.daily_exercise.exercise.external_id }}.png"
                alt="{{ current_step.daily_exercise.exercise.name }} exercise demonstration"
                class="w-full object-contain"
                loading="lazy"
              />
            </figure>
          </div>
        </div>

        <div class="lg:col-span-5">
          <div class="rounded-3xl border border-slate-200 bg-white shadow-soft">
            <div class="border-b border-slate-200 px-6 py-5">
              <h2 class="mt-1 text-lg font-semibold tracking-tight text-slate-900">{{ current_step.daily_exercise.exercise.name }}</h2>
              <div class="mt-3 flex flex-wrap gap-2">
                <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-sm font-semibold text-slate-700">
                  {% if current_step.daily_exercise.repetitions %}
                    {{ current_step.daily_exercise.repetitions }} repetitions
                  {% else %}
                    Repetitions not specified
                  {% endif %}
                </span>
              </div>
            </div>

            <div class="p-6">
              {% if current_step.daily_exercise.exercise.info %}
              <div>
                <div class="text-sm font-semibold text-slate-900">How to do it</div>
                <p class="mt-2 text-sm leading-6 text-slate-600">{{ current_step.daily_exercise.exercise.info }}</p>
              </div>
              {% endif %}

              <div class="mt-6 flex flex-col gap-3 sm:flex-row">
                <form method="post" class="flex w-full justify-end sm:w-auto">
                  {% csrf_token %}
                  <button type="submit" class="inline-flex w-full items-center justify-center rounded-full bg-indigo-600 px-5 py-3 text-sm font-semibold text-white shadow-soft min-w-40 transition hover:bg-indigo-500 sm:w-auto">
                    Next
                    <span class="ml-2" aria-hidden="true">→</span>
                  </button>
                </form>
              </div>

              <div class="mt-6 rounded-2xl bg-slate-50 p-4">
                <div class="text-sm font-semibold text-slate-900">Session tips</div>
                <ul class="mt-2 space-y-2 text-sm text-slate-600">
                  <li class="flex gap-2"><span>Move slow. No bouncing.</span></li>
                  <li class="flex gap-2"><span>Stop if pain spikes or sharpens.</span></li>
                  <li class="flex gap-2"><span>Consistency beats intensity.</span></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>
    {% elif post_exercise_stage == 0 %}
      <div class="rounded-3xl border border-slate-200 bg-white shadow-soft">
        <div class="border-b border-slate-200 px-6 py-5">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Recovery</p>
          <h2 class="mt-1 text-xl font-semibold tracking-tight text-slate-900">Sleep &amp; nutrition check-in</h2>
          <p class="mt-2 text-sm text-slate-600">Take a moment to record how you rested and what you ate today.</p>
        </div>

        <div class="p-6">
          {% if recovery_form.non_field_errors %}
            <div class="mb-4 rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm font-semibold text-rose-700">{{ recovery_form.non_field_errors }}</div>
          {% endif %}

          <form method="post" class="grid grid-cols-1 gap-4">
            {% csrf_token %}

            <div>
              <label for="id_sleep_duration" class="block text-sm font-semibold text-slate-900">Sleep Time</label>
              <div class="mt-2 flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-3 shadow-sm focus-within:ring-2 focus-within:ring-indigo-600/30 max-w-80">
                {{ recovery_form.sleep_duration.as_widget(attrs={
                  'class': 'w-full bg-transparent text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none',
                  'inputmode': 'numeric',
                  'aria-describedby': 'sleep-duration-help'
                }) }}
              </div>
              <p id="sleep-duration-help" class="mt-2 text-xs text-slate-500">Format: H:MM (example: 7:20).</p>
              {% if recovery_form.sleep_duration.errors %}
                <div class="mt-2 rounded-xl bg-rose-50 px-3 py-2 text-sm font-semibold text-rose-700">{{ recovery_form.sleep_duration.errors }}</div>
              {% endif %}
            </div>

            <div>
              <label for="id_sleep_quality" class="block text-sm font-semibold text-slate-900">Sleep Quality</label>
              <div class="mt-2 flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-3 shadow-sm focus-within:ring-2 focus-within:ring-indigo-600/30 max-w-80">
                {{ recovery_form.sleep_quality.as_widget(attrs={
                  'class': 'w-full bg-transparent text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none'
                }) }}
                <span class="text-xs font-semibold text-slate-500">%</span>
              </div>
              {% if recovery_form.sleep_quality.errors %}
                <div class="mt-2 rounded-xl bg-rose-50 px-3 py-2 text-sm font-semibold text-rose-700">{{ recovery_form.sleep_quality.errors }}</div>
              {% endif %}
            </div>

            <div>
              <label for="id_nutrition" class="block text-sm font-semibold text-slate-900">Nutrition</label>
              <div class="mt-2 rounded-2xl border border-slate-200 bg-white px-4 py-3 shadow-sm focus-within:ring-2 focus-within:ring-indigo-600/30 max-w-80">
                {{ recovery_form.nutrition.as_widget(attrs={
                  'class': 'w-full bg-transparent text-sm font-semibold text-slate-900 focus:outline-none'
                }) }}
              </div>
              {% if recovery_form.nutrition.errors %}
                <div class="mt-2 rounded-xl bg-rose-50 px-3 py-2 text-sm font-semibold text-rose-700">{{ recovery_form.nutrition.errors }}</div>
              {% endif %}
            </div>

            <div>
              <label for="id_comment" class="block text-sm font-semibold text-slate-900">Custom comment for the trainer</label>
              {{ recovery_form.comment.as_widget(attrs={
                'class': 'mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 placeholder:text-slate-400 shadow-sm focus:border-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-600/30'
              }) }}
              {% if recovery_form.comment.errors %}
                <div class="mt-2 rounded-xl bg-rose-50 px-3 py-2 text-sm font-semibold text-rose-700">{{ recovery_form.comment.errors }}</div>
              {% endif %}
            </div>

            <div class="mt-2 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
              <div class="flex flex-col gap-2 sm:flex-row">
                <button type="button" onclick="history.back()" class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-5 py-3 text-sm font-semibold text-slate-700 shadow-soft transition hover:bg-slate-50">
                  Back
                </button>
                <button type="submit" class="inline-flex items-center justify-center rounded-full bg-indigo-600 px-5 py-3 text-sm font-semibold text-white shadow-soft transition hover:bg-indigo-500 w-full min-w-40">
                  Next
                  <span class="ml-2" aria-hidden="true">→</span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    {% elif post_exercise_stage == 1 %}
      <div class="rounded-3xl border border-slate-200 bg-white shadow-soft">
        <div class="border-b border-slate-200 px-6 py-5">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Feedback</p>
          <h2 class="mt-1 text-xl font-semibold tracking-tight text-slate-900">Fatigue Assessment (5 questions)</h2>
          <p class="mt-2 text-sm text-slate-600">Answer how you usually feel.</p>
        </div>

        <div class="p-6">
          <form method="post" class="space-y-6">
            {% csrf_token %}
            <div class="space-y-4">
              {% for question in fas_questions %}
                <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Question {{ forloop.counter }}</p>
                  <h3 class="mt-1 text-lg font-semibold text-slate-900">{{ question.text }}</h3>
                  <div class="mt-3 slider-field">
                    <div class="slider__bubble" aria-hidden="true">
                      <span class="slider__value">Never</span>
                      <span class="slider__detail">About monthly or less</span>
                      <span class="slider__arrow"></span>
                    </div>
                    {{ question.form_field }}
                    <div class="slider__labels">
                      <span>Never</span>
                      <span>Always</span>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>

            <div>
              <button type="submit" class="inline-flex items-center justify-center rounded-full bg-indigo-600 px-5 py-3 text-sm font-semibold text-white shadow-soft transition hover:bg-indigo-500">Next</button>
            </div>
          </form>
        </div>
      </div>
      {{ fas_options|json_script:"fas-options-data" }}
      <script>
          (function () {
              const options = JSON.parse(document.getElementById("fas-options-data").textContent);

              function findOption(value) {
                  return options.find((option) => option.value === value) || options[0];
              }

              function updateBubble(slider) {
                  const bubble = slider.parentElement.querySelector(".slider__bubble");
                  const value = Number(slider.value);
                  const option = findOption(value);

                  bubble.querySelector(".slider__value").textContent = option.label;
                  const detail = bubble.querySelector(".slider__detail");
                  detail.textContent = option.detail || "";
                  detail.style.display = option.detail ? "block" : "none";

                  const min = Number(slider.min || 0);
                  const max = Number(slider.max || 1);
                  const percent = (value - min) / (max - min);

                  const trackWidth = slider.clientWidth;
                  const thumbWidth = 22;
                  const available = Math.max(trackWidth - thumbWidth, 0);
                  const position = percent * available + thumbWidth / 2;

                  bubble.style.left = `${position}px`;
              }

              document.querySelectorAll(".fas-slider").forEach((slider) => {
                  let hideTimeout;
                  const field = slider.closest(".slider-field");

                  function showBubble() {
                      clearTimeout(hideTimeout);
                      field.classList.add("is-active");
                  }

                  function hideBubble() {
                      hideTimeout = setTimeout(() => field.classList.remove("is-active"), 250);
                  }

                  updateBubble(slider);

                  slider.addEventListener("input", () => {
                      updateBubble(slider);
                      showBubble();
                  });

                  slider.addEventListener("pointerenter", showBubble);
                  slider.addEventListener("pointerdown", showBubble);
                  slider.addEventListener("pointerleave", hideBubble);
                  slider.addEventListener("focus", showBubble);
                  slider.addEventListener("blur", hideBubble);
              });
          })();
      </script>
    {% else %}
      <div class="rounded-3xl border border-slate-200 bg-white p-8 text-center shadow-soft">
        <h2 class="text-2xl font-semibold text-slate-900">All done for today</h2>
        <p class="mt-2 text-sm text-slate-600">You completed all exercises and check-ins. Great work!</p>
        <div class="mt-5 flex justify-center">
          <a class="inline-flex items-center justify-center rounded-full bg-indigo-600 px-5 py-3 text-sm font-semibold text-white shadow-soft transition hover:bg-indigo-500" href="{% url 'health' %}">Back to health overview</a>
        </div>
      </div>
    {% endif %}
  {% else %}
    <div class="rounded-3xl border border-slate-200 bg-white p-6 text-sm text-slate-700 shadow-soft">No exercises scheduled for today yet. Come back after your plan is generated.</div>
  {% endif %}
</div>
{% endblock %}
