{% extends "base_authenticated.html" %}

{% block title %}Exercise session | Knees{% endblock %}

{% block content %}
<section class="session">
    <div class="session__header">
        <div>
            <p class="eyebrow">{{ headline }}</p>
            <h1>{{ title }}</h1>
        </div>
        <div class="session__progress-meta">
            <span>Step {{ current_step_number }} of {{ total_steps }}</span>
            <span class="muted">{{ progress_percent|floatformat:0 }}% complete</span>
        </div>
    </div>

    <div class="progress">
        <div class="progress__track">
            <div class="progress__fill" style="width: {{ progress_percent }}%"></div>
        </div>
    </div>

    {% if steps %}
        {% if current_step %}
            <div class="session__body">
                <div class="session__media">
                    <div class="media-placeholder">
                        <div class="play-icon">▶</div>
                    </div>
                </div>
                <div class="session__details">
                    <p class="eyebrow">Set {{ current_step.set_number }} of {{ current_step.daily_exercise.sets|default:1 }}</p>
                    <h2>{{ current_step.daily_exercise.exercise.name }}</h2>
                    <p class="reps">{{ current_step.daily_exercise.repetitions|default:"Repetitions not specified" }}</p>
                    <p class="muted">Difficulty {{ current_step.daily_exercise.exercise.difficulty_range }}</p>

                    <form method="post" class="session__actions">
                        {% csrf_token %}
                        <button type="submit" class="button primary">
                            Next
                            <span class="icon">▶</span>
                        </button>
                    </form>
                </div>
            </div>
        {% elif post_exercise_stage == 0 %}
            <div class="session__body">
                <form method="post" class="session__text-card session__form">
                    {% csrf_token %}
                    <p class="eyebrow">Recovery</p>
                    <h2>Sleep &amp; nutrition check-in</h2>
                    <p class="muted">Take a moment to record how you rested and what you ate today.</p>

                    {% if recovery_form.non_field_errors %}
                        <div class="form__errors">{{ recovery_form.non_field_errors }}</div>
                    {% endif %}

                    <label for="id_sleep_duration">Sleep Time</label>
                    {{ recovery_form.sleep_duration }}
                    {% if recovery_form.sleep_duration.errors %}
                        <div class="form__errors">{{ recovery_form.sleep_duration.errors }}</div>
                    {% endif %}

                    <label for="id_sleep_quality">Sleep Quality</label>
                    {{ recovery_form.sleep_quality }}
                    {% if recovery_form.sleep_quality.errors %}
                        <div class="form__errors">{{ recovery_form.sleep_quality.errors }}</div>
                    {% endif %}

                    <label for="id_nutrition">Nutrition</label>
                    {{ recovery_form.nutrition }}
                    {% if recovery_form.nutrition.errors %}
                        <div class="form__errors">{{ recovery_form.nutrition.errors }}</div>
                    {% endif %}

                    <label for="id_comment">Custom Comment for the trainer</label>
                    {{ recovery_form.comment }}
                    {% if recovery_form.comment.errors %}
                        <div class="form__errors">{{ recovery_form.comment.errors }}</div>
                    {% endif %}

                    <div class="session__actions">
                        <button type="submit" class="button primary">Next</button>
                    </div>
                </form>
            </div>
        {% elif post_exercise_stage == 1 %}
            <div class="session__body">
                <form method="post" class="session__text-card session__form fas-form">
                    {% csrf_token %}
                    <p class="eyebrow">Feedback</p>
                    <h2>Fatigue Assessment (5 questions)</h2>
                    <p class="muted">Answer how you usually feel.</p>

                    <div class="fas-questions">
                        {% for question in fas_questions %}
                            <div class="fas-question">
                                <div class="fas-question__meta">
                                    <p class="eyebrow">Question {{ forloop.counter }}</p>
                                </div>
                                <h3>{{ question.text }}</h3>
                                <div class="fas-question__scale">
                                    <div class="slider-field">
                                        <div class="slider__bubble" aria-hidden="true">
                                            <span class="slider__value">Never</span>
                                            <span class="slider__detail">About monthly or less</span>
                                            <span class="slider__arrow"></span>
                                        </div>
                                        {{ question.form_field }}
                                        <div class="slider__labels">
                                            <span>Never</span>
                                            <span>Always</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="session__actions">
                        <button type="submit" class="button primary">Next</button>
                    </div>
                </form>
            </div>
            {{ fas_options|json_script:"fas-options-data" }}
            <script>
                (function () {
                    const options = JSON.parse(document.getElementById("fas-options-data").textContent);

                    function findOption(value) {
                        return options.find((option) => option.value === value) || options[0];
                    }

                    function updateBubble(slider) {
                        const bubble = slider.parentElement.querySelector(".slider__bubble");
                        const value = Number(slider.value);
                        const option = findOption(value);

                        bubble.querySelector(".slider__value").textContent = option.label;
                        const detail = bubble.querySelector(".slider__detail");
                        detail.textContent = option.detail || "";
                        detail.style.display = option.detail ? "block" : "none";

                        const min = Number(slider.min || 0);
                        const max = Number(slider.max || 1);
                        const percent = (value - min) / (max - min);

                        const trackWidth = slider.clientWidth;
                        const thumbWidth = 22;
                        const available = Math.max(trackWidth - thumbWidth, 0);
                        const position = percent * available + thumbWidth / 2;

                        bubble.style.left = `${position}px`;
                    }

                    document.querySelectorAll(".fas-slider").forEach((slider) => {
                        let hideTimeout;
                        const field = slider.closest(".slider-field");

                        function showBubble() {
                            clearTimeout(hideTimeout);
                            field.classList.add("is-active");
                        }

                        function hideBubble() {
                            hideTimeout = setTimeout(() => field.classList.remove("is-active"), 250);
                        }

                        updateBubble(slider);

                        slider.addEventListener("input", () => {
                            updateBubble(slider);
                            showBubble();
                            hideBubble();
                        });

                        slider.addEventListener("pointerdown", showBubble);
                        slider.addEventListener("pointerup", hideBubble);
                        slider.addEventListener("pointerleave", hideBubble);
                        slider.addEventListener("blur", hideBubble);
                    });
                })();
            </script>
        {% else %}
            <div class="session__body">
                <div class="session__text-card">
                    <h2>All done for today</h2>
                    <p class="muted">You completed all exercises and check-ins. Great work!</p>
                    <div class="session__actions">
                        <a class="button" href="{% url 'health' %}">Back to health overview</a>
                    </div>
                </div>
            </div>
        {% endif %}
    {% else %}
        <p>No exercises scheduled for today yet. Come back after your plan is generated.</p>
    {% endif %}
</section>
{% endblock %}
